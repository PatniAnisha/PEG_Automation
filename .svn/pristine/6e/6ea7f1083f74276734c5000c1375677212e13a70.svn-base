package SanityDefault;

import java.nio.charset.StandardCharsets;

import javax.xml.bind.DatatypeConverter;

import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.Keys;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;

import com.relevantcodes.extentreports.ExtentTest;
import com.relevantcodes.extentreports.LogStatus;

import Framework.ConfigurationProperties;
import Common.CommonFunctions;

public class Login extends CommonFunctions {

	private WebDriver driver;
	private ExtentTest logger;
	private String username;
	private String password;
	private String product;
	private String customer;

	public Login(WebDriver driver, ExtentTest logger, String username, String password)
			throws Exception {
		super(driver, logger);
		this.driver = driver;
		this.logger = logger;
		this.username = username;
		this.password = password;
	}
	
	public Login(WebDriver driver, ExtentTest logger, String product, String username, String password,
			String customer) throws Exception {
		super(driver, logger);
		this.driver = driver;
		this.logger = logger;
		this.product = product;
		this.username = username;
		this.password = password;
		this.customer = customer;
	}

	public boolean login(ConfigurationProperties configurationProperties) {
		boolean result = false;
		try {
			String URL = configurationProperties.getProperty("url_ZSN");
			
			//Launch URL
			driver.manage().window().maximize();
			driver.get(URL);
			
			//Enter credentials & click Login button
			sendKeys(By.id("login-email"), username);
			logger.log(LogStatus.INFO, "username entered is " + username);
			sendKeys(By.id("login-password"),
					new String(DatatypeConverter.parseBase64Binary(password), StandardCharsets.UTF_8));
			click(By.xpath("//div/input[contains(@class,'btn btn-primary')]"));
			
			try{
				if (findElement(By.xpath("//img[@class='zsp-logo-image']")).isDisplayed()) {
					waitUntilInvisibilityOfElement(By.id("notification-overlay"));
					LogScreenshot("INFO", "logged in to ZSN portal");
					result = true;
				}else{
					logger.log(LogStatus.INFO, "home page not displayed");
					return result;
				}
			}catch(Exception e){
				return result;
			}
			/*if (findElement(By.xpath("//div[contains(@class,'error-message')]")).isDisplayed()) 
				logger.log(LogStatus.INFO, "unable to log in to ZSN portal");*/
		} catch (Exception e) {
			e.printStackTrace();
		}
		return result;

	}
	
	/**
	 * <b>Function:</b> login - Login function
	 * 
	 * @author Varun Khurana
	 * @since April 2018
	 * @param configurationProperties
	 * @return none
	 */

	public boolean Login_via_PwdMgr(ConfigurationProperties configurationProperties) {
		boolean result = false;
		//DO NOT REMOVE Thread.sleep FOR LOGIN AND PRODUCT SELECTION IN CLASSIC VIEW
		try {
			String URL = configurationProperties.getProperty("url_PM");
			driver.manage().window().maximize();
			driver.get(URL);

			writeText(By.id("username"), username);
			/*sendKeys(By.id("password"),
					new String(DatatypeConverter.parseBase64Binary(password), StandardCharsets.UTF_8));*/
			findElement(By.id("password")).sendKeys("ani17sha@");
			findElement(By.xpath("//*[@title='Login']")).submit();
			findElement(By.id("FRHost_Search")).sendKeys(customer + Keys.ENTER);
			if (findElement(By.xpath("//div[@unique_id='SearchResult' and @id='MainDAC']")) != null) {
				findElement(By.id("bedit")).click();
				Thread.sleep(3000);
				String parent = driver.getWindowHandle();
				findElement(By.xpath("//img[@id='rdp_ico_0']")).click();
				Thread.sleep(3000);
				findElement(By.xpath("//a[contains(text(),'Open URL in browser')]")).click();
				driver.switchTo().window(parent);
				findElement(By.xpath("//img[@id='rdp_ico_0']")).click();
				Thread.sleep(3000);
				findElement(By.xpath("//a[contains(text(),'Open URL in browser')]")).click();
				switchWindowHandles(parent, "Product Selection");
				Thread.sleep(12000);
				WebElement element = null;
				JavascriptExecutor js = (JavascriptExecutor) driver;
				try {
					WebElement switchView = findElement(By.xpath("//p[text()='Switch back to Classic View']"));
					if (switchView.isDisplayed()) {
						switchView.click();
						Thread.sleep(3000);
						if (driver.findElement(By.xpath(".//*[@class='rb-switchBlk rb-clearfix rb-dropbox-show']"))
								.isDisplayed()) {
							js.executeScript("document.getElementById('switchToClassicView').click();");
							Thread.sleep(3000);
						}
						findElement(By.xpath("//div[@class='rb-viewalert-without-loader']//span[2]")).click();
						driver.switchTo().window(parent);
						findElement(By.xpath("//img[@id='rdp_ico_0']")).click();
						Thread.sleep(3000);
						findElement(By.xpath("//a[contains(text(),'Open URL in browser')]")).click();
						Thread.sleep(3000);
						switchWindowHandles(parent, "Product Selection");
						Thread.sleep(12000);
					}
				} catch (Exception e) {
					System.out.println(e.getMessage());
				}
				String modifiedXpath = "activePan_" + product;
				element = findElement(By.id(modifiedXpath));
				js.executeScript("arguments[0].click();", element);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return result;
	}

}
